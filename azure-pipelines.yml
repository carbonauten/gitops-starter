trigger:
  branches:
    include:
      - main

variables:
  # Update these to match your registry / image names
  imageName: 'example-service'
  containerRegistry: '$(ACR_LOGIN_SERVER)' # set in pipeline variables or use full name like myregistry.azurecr.io
  imageTag: '$(Build.SourceVersion)'

stages:
  - stage: Build
    displayName: Build and Push image
    jobs:
      - job: Build
        pool:
          vmImage: 'ubuntu-latest'
        steps:
          - task: Checkout@1

          - task: Docker@2
            displayName: Build and push image to ACR
            inputs:
              command: buildAndPush
              repository: '$(containerRegistry)/$(imageName)'
              dockerfile: 'services/example-service/Dockerfile'
              tags: |
                $(imageTag)
                latest
              containerRegistry: 'ACRServiceConnection' # replace with your Azure DevOps service connection name

  - stage: Deploy
    displayName: Deploy (optional)
    dependsOn: Build
    condition: succeeded()
    jobs:
      - deployment: DeployToK8s
        displayName: Deploy to Kubernetes (via kubectl)
        environment: 'staging'
        pool:
          vmImage: 'ubuntu-latest'
        strategy:
          runOnce:
            deploy:
              steps:
                - task: KubectlInstaller@0
                  inputs:
                    kubectlVersion: 'latest'

                - task: AzureCLI@2
                  inputs:
                    azureSubscription: 'AzureServiceConnection' # replace with your service connection
                    scriptType: 'bash'
                    scriptLocation: 'inlineScript'
                    inlineScript: |
                      echo "Updating Helm values and deploying"
                      kubectl set image deployment/example-service example-service=$(containerRegistry)/$(imageName):$(imageTag) --namespace default || true

# Notes:
# - Create an Azure DevOps service connection named 'ACRServiceConnection' that points to your ACR.
# - Set the pipeline variable 'ACR_LOGIN_SERVER' to your registry host (e.g. myregistry.azurecr.io) or replace usage with a literal.
# - The Deploy stage is optional and expects the cluster credentials to be available via the Azure service connection.
